#!/bin/sh
# shellcheck disable=SC2086

main() {
        ssh() { command ssh -F ~/.config/ssh/config "$@"; }

        hostname="${1?Need a name, e.g. mia, atl, tor, dlas1, plas1}"
        ip="$(ssh -G "$hostname" | awk '/^hostname/ {print $2}' | xargs dig +short)"

        case "$hostname" in
                mia)
                        ranges='
                    10.96.0.0/11
                    10.128.0.0/10
                    '
                        ;;
                atl)
                        ranges='
                    10.99.0.0/16
                    10.100.0.0/16
                '
                        ;;
                tor)
                        ranges='
                    10.130.0.0/16
                    10.140.0.0/16
                    '
                        ;;
                dlas1)
                        ranges='
                    10.150.0.0/16
                    '
                        ;;
                plas1)
                        ranges='
                    10.147.0.0/16
                    10.151.0.0/16
                    '
                        ;;
        esac

        trap cleanup EXIT
        for net in $ranges; do
                sudo route add -net "$net" -iface lo0
        done

        #--dns \
        sshuttle \
                -v \
                --ssh-cmd "ssh -F $HOME/.config/ssh/config" \
                --remote "$hostname" \
                --exclude "$ip" \
                $ranges

        echo
}

cleanup() {
        for net in $ranges; do
                sudo route delete -net "$net" -iface lo0
        done
}

main "$@"
