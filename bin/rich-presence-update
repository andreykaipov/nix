#!/bin/bash
# shellcheck disable=SC2154

getshortenedpath() {
        arg="$1"

        case "$arg" in
                "$HOME") shortenedpath=' ~ ' ;; # details must be >= 2 chars
                "$HOME"*)
                        shortenedpath="$(
                                # shellcheck disable=SC2086
                                dirs=$(
                                        IFS=/
                                        printf '%s\n' ${arg/$HOME/'~'}
                                )
                                i="$(echo "$dirs" | wc -l)"
                                for p in $dirs; do
                                        i=$((i - 1))
                                        if [ $i -lt 2 ]; then
                                                echo "$p"
                                                continue
                                        fi
                                        echo "${p:0:1}"
                                done | paste -sd /
                        )"
                        ;;
                *)
                        shortenedpath="$arg"
                        ;;
        esac

        echo "$shortenedpath"
}

main() {
        if [ -n "${SKIP_RICH_PRESENCE-}" ]; then return; fi

        kind="$1"
        shift
        details="tmux $(tmux id)"
        since=cached
        cache_key=local
        cache_write=if_not_present
        small_image=

        case "$kind" in
                init-rp-session)
                        state=
                        since=now
                        cache_key=local
                        cache_write=always
                        ;;
                vi-open)
                        since=now
                        state="$*"
                        small_image=vim_square
                        cache_key="$*"
                        cache_write=always
                        ;;
                vi-move)
                        linecol="$1"
                        shift
                        cache_key="$*"
                        small_image=cached
                        state="üëÄ $* $linecol"
                        ;;
                vi-movei)
                        linecol="$1"
                        shift
                        cache_key="$*"
                        small_image=cached
                        state="‚úçüèΩ $* $linecol"
                        ;;
                vi-quit)
                        state="‚ùØ "
                        ;;
                bash-command)
                        state="‚ùØ $*"
                        ;;
                pane-focus-in)
                        state="‚ùØ "
                        ;;
                *)
                        return
                        details="unknown"
                        state="unknown"
                        ;;
        esac

        ~/projects/personal/rich-presence-cli/bin/release/rich-presence-linux-amd64 update \
                --details "$details" \
                --state "$state" \
                --small-image "$small_image" \
                --since "$since" \
                --cache-key "$cache_key" \
                --cache-write "$cache_write"
}

set -eu
main "$@"
